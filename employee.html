<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Employee Attendance & Salary</title>
<style>
/* Navbar */
.navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #3498db;
  color: #fff;
  padding: 10px 15px;
  border-radius: 0 0 10px 10px;
}
.navbar button {
  background: #2ce029;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}
.navbar button:hover { background: #1f618d; }

body {
  font-family: "Segoe UI", sans-serif;
  background: #f0f4f8;
  margin: 0;
  padding: 10px;
}
h1, h2 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
.container { max-width: 1000px; margin: auto; }

.card {
  background: #fff;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}

form label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
form input, form select, form button {
  width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px;
  border-radius: 8px; border: 1px solid #ccc; font-size: 14px;
}
form button {
  background: #3498db; color: #fff; font-weight: bold;
  cursor: pointer; transition: 0.3s;
}
form button:hover { background: #2980b9; }

.table-wrapper { overflow-x: auto; }
.employee-table {
  width: 100%; border-collapse: collapse; margin-top: 10px;
}
.employee-table th, .employee-table td {
  border: 1px solid #eee; padding: 8px; text-align: center; font-size: 13px;
}
.employee-table thead { background: #3498db; color: #fff; }

.attendance-grid {
  display: flex; flex-wrap: wrap; justify-content: center; gap: 4px;
}
.attendance-btn {
  width: 35px; height: 35px; border-radius: 50%;
  font-weight: bold; font-size: 11px; color: #fff;
  cursor: pointer; border: none; transition: 0.2s;
}
.attendance-btn:hover { transform: scale(1.15); }
.present { background: #27ae60; }
.absent { background: #e74c3c; }
.half { background: #f39c12; }
.empty { background: #bdc3c7; color: #666; }

.btn { padding: 4px 8px; border: none; border-radius: 6px; cursor: pointer; margin: 2px; font-size: 12px; }
.btn-edit { background: #f1c40f; color: #fff; }
.btn-edit:hover { background: #d4ac0d; }
.btn-delete { background: #e74c3c; color: #fff; }
.btn-delete:hover { background: #c0392b; }

/* Advance Popup */
.advance-popup {
  position: absolute; background: #fff; border: 1px solid #ccc;
  border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  padding: 6px; z-index: 1000;
}
.advance-popup button {
  margin: 3px; padding: 5px 8px; border: none;
  border-radius: 6px; cursor: pointer; background: #3498db;
  color: white; font-size: 12px;
}
.advance-popup button:hover { background: #2e86c1; }

/* Advance List */
.advance-list {
  margin-top: 5px;
  font-size: 12px;
  color: #2c3e50;
  text-align: center;
  background: #f9f9f9;
  border-radius: 6px;
  padding: 4px;
}

@media (max-width: 768px) {
  .employee-table { display: none; }
  .attendance-btn { width: 24px; height: 24px; font-size: 10px; }
}
</style>
</head>
<body>
<div class="navbar">
  <button onclick="window.location.href='product.html'">Products</button>
</div>

<div class="container">
  <h1>Employee Attendance & Salary</h1>

  <div class="card">
    <h2>Add Employee</h2>
    <form id="employeeForm">
      <label>Name: <input type="text" id="name" required /></label>
      <label>Position:
        <select id="position" required>
          <option value="Employee">Employee</option>
          <option value="Supervisor">Supervisor</option>
        </select>
      </label>
      <label>Email: <input type="email" id="email" required /></label>
      <label>Phone: <input type="text" id="phone" required /></label>
      <label>Password: <input type="text" id="password" required /></label>
      <label>Salary per day: <input type="number" id="salary" required /></label>
      <button type="submit">Add Employee</button>
    </form>
  </div>

  <div class="card">
    <h2>All Employees</h2>
    <div class="table-wrapper">
      <table class="employee-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Position</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Password</th>
            <th>Month</th>
            <th>Attendance</th>
            <th>Salary/Day</th>
            <th>Monthly Salary</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="employeeList"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDz-C00gltYO9zkYvcrGnaPVwCHcem-7jY",
  authDomain: "arafa-bakery-33906.firebaseapp.com",
  projectId: "arafa-bakery-33906",
  storageBucket: "arafa-bakery-33906.appspot.com",
  messagingSenderId: "362520951276",
  appId: "1:362520951276:web:ead930237865e9aa69e8c9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const employeeList = document.getElementById("employeeList");
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const attendanceData = {};
const currentDate = new Date();
const currentYear = currentDate.getFullYear();
const currentMonth = currentDate.getMonth() + 1;

function getDaysInMonth(y, m) { return new Date(y, m, 0).getDate(); }

async function loadEmployees() {
  const snapshot = await getDocs(collection(db, "employees"));
  employeeList.innerHTML = "";
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id;
    if (!data.attendance) data.attendance = {};
    if (!attendanceData[id]) attendanceData[id] = { ...data.attendance };
    const yearSelect = `<select id="year-${id}" onchange="renderAttendanceGrid('${id}')">
      ${[...Array(6)].map((_, y)=>`<option value="${2024 + y}" ${currentYear===2024+y?"selected":""}>${2024+y}</option>`).join("")}
    </select>`;
    const monthSelect = `<select id="month-${id}" onchange="renderAttendanceGrid('${id}')">
      ${monthNames.map((m,i)=>`<option value="${i+1}" ${currentMonth===i+1?"selected":""}>${m}</option>`).join("")}
    </select>`;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input type="text" value="${data.name}" id="name-${id}"></td>
      <td><select id="position-${id}">
        <option value="Employee" ${data.position==="Employee"?"selected":""}>Employee</option>
        <option value="Supervisor" ${data.position==="Supervisor"?"selected":""}>Supervisor</option>
      </select></td>
      <td><input type="email" value="${data.email}" id="email-${id}"></td>
      <td><input type="text" value="${data.phone}" id="phone-${id}"></td>
      <td><input type="text" value="${data.password}" id="password-${id}"></td>
      <td>${monthSelect} ${yearSelect}</td>
      <td>
        <div id="attendance-grid-${id}" class="attendance-grid"></div>
        <div id="advance-list-${id}" class="advance-list"></div>
      </td>
      <td><input type="number" id="salary-${id}" value="${data.salary || 0}"></td>
      <td id="monthly-salary-${id}">0</td>
      <td>
        <button class="btn btn-edit" onclick="updateEmployee('${id}')">Update</button>
        <button class="btn btn-delete" onclick="deleteEmployee('${id}')">Delete</button>
      </td>`;
    employeeList.appendChild(tr);
    renderAttendanceGrid(id);
  });
}

window.renderAttendanceGrid = function(id){
  const year = parseInt(document.getElementById(`year-${id}`).value);
  const month = parseInt(document.getElementById(`month-${id}`).value);
  const monthKey = `${year}-${month.toString().padStart(2,"0")}`;
  if(!attendanceData[id][monthKey]) attendanceData[id][monthKey] = {};
  const days = getDaysInMonth(year,month);
  const grid = [];
  let totalSalary=0, totalAdvance=0;
  const perDay = parseFloat(document.getElementById(`salary-${id}`)?.value || 0);
  const advances = [];

  for(let d=1; d<=days; d++){
    const ds = d.toString().padStart(2,"0");
    const dayData = attendanceData[id][monthKey][ds] || {status:"",advance:0};
    const s = dayData.status;
    const c = s==="P"?"present":s==="A"?"absent":s==="H"?"half":"empty";
    grid.push(`<button class="attendance-btn ${c}" title="Advance ₹${dayData.advance||0}" onclick="toggleAttendance('${id}','${monthKey}','${ds}',this)">${d}</button>`);
    if(s==="P") totalSalary+=perDay;
    else if(s==="H") totalSalary+=perDay/2;
    totalAdvance+=dayData.advance||0;
    if(dayData.advance>0) advances.push(`${d} → ₹${dayData.advance}`);
  }

  document.getElementById(`attendance-grid-${id}`).innerHTML = grid.join("");
  document.getElementById(`advance-list-${id}`).innerHTML =
    advances.length ? `<b>Advances:</b> ${advances.join(", ")}` : "<i>No advances this month</i>";

  const finalSalary = totalSalary - totalAdvance;
  document.getElementById(`monthly-salary-${id}`).textContent = `₹${finalSalary.toFixed(2)} (Adv ₹${totalAdvance})`;
};

window.toggleAttendance = function(id, monthKey, day, button){
  if(!attendanceData[id][monthKey]) attendanceData[id][monthKey] = {};
  let d = attendanceData[id][monthKey][day] || {status:"",advance:0};
  if(d.status==="") d.status="P";
  else if(d.status==="P") d.status="A";
  else if(d.status==="A") d.status="H";
  else d.status="";
  attendanceData[id][monthKey][day]=d;
  renderAttendanceGrid(id);
  showAdvancePopup(id, monthKey, day, button);
};

function showAdvancePopup(id, monthKey, day, button){
  document.querySelectorAll(".advance-popup").forEach(p=>p.remove());
  const popup=document.createElement("div");
  popup.className="advance-popup";
  popup.innerHTML=[100,200,300,400].map(a=>`<button>${a}</button>`).join("") + "<button>Custom</button>";
  document.body.appendChild(popup);
  const r=button.getBoundingClientRect();
  popup.style.top=r.bottom+window.scrollY+"px";
  popup.style.left=r.left+window.scrollX+"px";
  popup.querySelectorAll("button").forEach(btn=>{
    btn.onclick=()=>{
      let amt = btn.textContent==="Custom" ? parseFloat(prompt("Enter custom amount")||0) : parseFloat(btn.textContent);
      if(!attendanceData[id][monthKey][day]) attendanceData[id][monthKey][day]={status:"",advance:0};
      attendanceData[id][monthKey][day].advance=amt;
      popup.remove();
      renderAttendanceGrid(id);
    };
  });
}
document.addEventListener("click",e=>{
  if(!e.target.closest(".advance-popup") && !e.target.classList.contains("attendance-btn"))
    document.querySelectorAll(".advance-popup").forEach(p=>p.remove());
});

document.getElementById("employeeForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const data = {
    name: name.value,
    position: position.value,
    email: email.value,
    phone: phone.value,
    password: password.value,
    salary: parseFloat(salary.value),
    attendance: {}
  };
  await addDoc(collection(db,"employees"),data);
  e.target.reset();
  loadEmployees();
});

window.updateEmployee = async function(id){
  const empRef = doc(db,"employees",id);
  const updated = {
    name: document.getElementById(`name-${id}`).value,
    position: document.getElementById(`position-${id}`).value,
    email: document.getElementById(`email-${id}`).value,
    phone: document.getElementById(`phone-${id}`).value,
    password: document.getElementById(`password-${id}`).value,
    salary: parseFloat(document.getElementById(`salary-${id}`).value),
    attendance: attendanceData[id]
  };
  await updateDoc(empRef, updated);
  alert("✅ Employee updated successfully!");
  loadEmployees();
};

window.deleteEmployee = async function(id){
  const pass=prompt("Enter admin password:");
  if(pass!=="1234567890") return alert("❌ Wrong password!");
  if(confirm("Delete this employee?")){
    await deleteDoc(doc(db,"employees",id));
    delete attendanceData[id];
    loadEmployees();
  }
};

window.onload = loadEmployees;
</script>
</body>
</html>
