<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Employee Attendance & Salary</title>
<style>
/* Navbar */
.navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #3498db;
  color: #fff;
  padding: 10px 15px;
  border-radius: 0 0 10px 10px;
  flex-wrap: wrap;
}
.navbar h1 {
  margin: 0;
  font-size: 18px;
  text-align: center;
}
.navbar button {
  background: #2ce029;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}
.navbar button:hover {
  background: #1f618d;
}

/* Body */
body {
  font-family: "Segoe UI", sans-serif;
  background: #f0f4f8;
  margin: 0;
  padding: 10px;
}

/* Headings */
h1, h2 {
  text-align: center;
  color: #2c3e50;
  margin-bottom: 10px;
}

/* Container */
.container {
  max-width: 1000px;
  margin: auto;
}

/* Card */
.card {
  background: #fff;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}

/* Form */
form label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  font-size: 14px;
}
form input, form select, form button {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  box-sizing: border-box;
}
form button {
  background: #3498db;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}
form button:hover {
  background: #2980b9;
}

/* Table (desktop) */
.table-wrapper {
  overflow-x: auto;
  width: 100%;
}
.employee-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
.employee-table th, .employee-table td {
  border: 1px solid #eee;
  padding: 8px;
  text-align: center;
  font-size: 13px;
}
.employee-table thead {
  background: #3498db;
  color: #fff;
}

/* Attendance buttons */
.attendance-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 4px;
}
.attendance-btn {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  font-weight: bold;
  font-size: 11px;
  color: #fff;
  cursor: pointer;
  border: none;
  transition: 0.2s;
}
.attendance-btn:hover {
  transform: scale(1.15);
}
.present { background: #27ae60; }
.absent { background: #e74c3c; }
.half { background: #f39c12; }
.empty { background: #bdc3c7; color: #666; }

/* Buttons */
.btn {
  padding: 4px 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin: 2px;
  font-size: 12px;
  transition: 0.3s;
}
.btn-edit {
  background: #f1c40f;
  color: #fff;
}
.btn-edit:hover { background: #d4ac0d; }
.btn-delete {
  background: #e74c3c;
  color: #fff;
}
.btn-delete:hover { background: #c0392b; }

/* --- MOBILE RESPONSIVE --- */
@media (max-width: 768px) {
  .employee-table { display: none; }
  .employee-card {
    background: #fff;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .employee-card h3 {
    color: #3498db;
    margin-bottom: 6px;
    font-size: 16px;
  }
  .employee-card p {
    margin: 2px 0;
    font-size: 13px;
    color: #444;
  }
  .employee-card select,
  .employee-card input {
    width: 100%;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 13px;
    margin-bottom: 8px;
  }
  .employee-card .actions {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
  }
  .attendance-grid {
    justify-content: flex-start;
  }
}
</style>
</head>
<body>
<!-- Navbar -->
<div class="navbar">
  <h1>Employee Attendance & Salary</h1>
  <button onclick="window.location.href='product.html'">Products</button>
</div>

<div class="container">
  <!-- Add Employee -->
  <div class="card">
    <h2>Add Employee</h2>
    <form id="employeeForm">
      <label>Name: <input type="text" id="name" required /></label>
      <label>Position:
        <select id="position" required>
          <option value="Employee">Employee</option>
          <option value="Supervisor">Supervisor</option>
        </select>
      </label>
      <label>Email: <input type="email" id="email" required /></label>
      <label>Phone: <input type="text" id="phone" required /></label>
      <label>Password: <input type="text" id="password" required /></label>
      <label>Salary per day: <input type="number" id="salary" required /></label>
      <button type="submit">Add Employee</button>
    </form>
  </div>

  <!-- All Employees -->
  <div class="card">
    <h2>All Employees</h2>
    <div class="table-wrapper">
      <table class="employee-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Position</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Password</th>
            <th>Month</th>
            <th>Attendance</th>
            <th>Salary/Day</th>
            <th>Monthly Salary</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="employeeList"></tbody>
      </table>
    </div>
    <div id="employeeCards"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDz-C00gltYO9zkYvcrGnaPVwCHcem-7jY",
  authDomain: "arafa-bakery-33906.firebaseapp.com",
  projectId: "arafa-bakery-33906",
  storageBucket: "arafa-bakery-33906.appspot.com",
  messagingSenderId: "362520951276",
  appId: "1:362520951276:web:ead930237865e9aa69e8c9",
  measurementId: "G-BY6R29F0QZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const employeeList = document.getElementById("employeeList");
const employeeCards = document.getElementById("employeeCards");
const attendanceData = {};
const advanceData = {};

const monthNames = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

const currentDate = new Date();
const currentYear = currentDate.getFullYear();
const currentMonth = currentDate.getMonth() + 1;

function getDaysInMonth(year, month) {
  return new Date(year, month, 0).getDate();
}

async function loadEmployees() {
  const snapshot = await getDocs(collection(db, "employees"));
  employeeList.innerHTML = "";
  employeeCards.innerHTML = "";

  snapshot.forEach((docSnap) => {
    const data = docSnap.data();
    const id = docSnap.id;
    if (!data.attendance) data.attendance = {};
    if (!data.salary) data.salary = 0;
    if (!data.advances) data.advances = {};
    attendanceData[id] = data.attendance;
    advanceData[id] = data.advances;

    // --- Desktop table row ---
    const yearSelect = `<select id="year-${id}" onchange="renderAttendanceGrid('${id}')">
      ${[...Array(11)].map(
        (_, y) => `<option value="${2025 + y}" ${currentYear === 2025 + y ? "selected" : ""}>${2025 + y}</option>`
      ).join("")}
    </select>`;
    const monthSelect = `<select id="month-${id}" onchange="renderAttendanceGrid('${id}')">
      ${monthNames.map(
        (m, idx) => `<option value="${idx + 1}" ${currentMonth === idx + 1 ? "selected" : ""}>${m}</option>`
      ).join("")}
    </select>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="text" value="${data.name}" id="name-${id}"></td>
      <td><select id="position-${id}">
          <option value="Employee" ${data.position === "Employee" ? "selected" : ""}>Employee</option>
          <option value="Supervisor" ${data.position === "Supervisor" ? "selected" : ""}>Supervisor</option>
      </select></td>
      <td><input type="email" value="${data.email}" id="email-${id}"></td>
      <td><input type="text" value="${data.phone}" id="phone-${id}"></td>
      <td><input type="text" value="${data.password}" id="password-${id}"></td>
      <td>${monthSelect} ${yearSelect}</td>
      <td id="attendance-grid-${id}" class="attendance-grid"></td>
      <td><input type="number" id="salary-${id}" value="${data.salary}"></td>
      <td id="monthly-salary-${id}">0</td>
      <td>
        <button class="btn btn-edit" onclick="updateEmployee('${id}')">Update</button>
        <button class="btn btn-delete" onclick="deleteEmployee('${id}')">Delete</button>
      </td>`;
    employeeList.appendChild(tr);

    // --- Mobile Card ---
    const card = document.createElement("div");
    card.className = "employee-card";
    card.innerHTML = `
      <h3>${data.name}</h3>
      <p><b>Position:</b> 
        <select id="position-${id}-m">
          <option value="Employee" ${data.position === "Employee" ? "selected" : ""}>Employee</option>
          <option value="Supervisor" ${data.position === "Supervisor" ? "selected" : ""}>Supervisor</option>
        </select></p>
      <p><b>Email:</b> <input type="email" id="email-${id}-m" value="${data.email}"></p>
      <p><b>Phone:</b> <input type="text" id="phone-${id}-m" value="${data.phone}"></p>
      <p><b>Password:</b> <input type="text" id="password-${id}-m" value="${data.password}"></p>
      <p><b>Month:</b> ${monthSelect} ${yearSelect}</p>
      <div id="attendance-grid-${id}-m" class="attendance-grid"></div>
      <p><b>Salary/day:</b> <input type="number" id="salary-${id}-m" value="${data.salary}"></p>
      <p><b>Total Salary:</b> <span id="monthly-salary-${id}-m">0</span></p>
      <div class="actions">
        <button class="btn btn-edit" onclick="updateEmployee('${id}', true)">Update</button>
        <button class="btn btn-delete" onclick="deleteEmployee('${id}')">Delete</button>
      </div>`;
    employeeCards.appendChild(card);

    renderAttendanceGrid(id);
  });
}

window.renderAttendanceGrid = function (id) {
  const year = parseInt(document.getElementById(`year-${id}`).value);
  const month = parseInt(document.getElementById(`month-${id}`).value);
  const monthKey = `${year}-${month.toString().padStart(2, "0")}`;

  if (!attendanceData[id][monthKey]) attendanceData[id][monthKey] = {};
  if (!advanceData[id][monthKey]) advanceData[id][monthKey] = {};

  const days = getDaysInMonth(year, month);
  const perDay = parseFloat(document.getElementById(`salary-${id}`).value || 0);
  let totalSalary = 0;
  let totalAdvance = 0;
  const grid = [];

  for (let d = 1; d <= days; d++) {
    const dayStr = d.toString().padStart(2, "0");
    const status = attendanceData[id][monthKey][dayStr] || "";
    const adv = advanceData[id][monthKey][dayStr] || 0;
    const colorClass =
      status === "P" ? "present" :
      status === "A" ? "absent" :
      status === "H" ? "half" : "empty";

    grid.push(
      `<button title="Advance: ₹${adv}" class="attendance-btn ${colorClass}" onclick="toggleAttendance('${id}','${monthKey}','${dayStr}')">${d}</button>`
    );

    if (status === "P") totalSalary += perDay;
    else if (status === "H") totalSalary += perDay / 2;
    totalAdvance += parseFloat(adv);
  }

  const finalSalary = totalSalary - totalAdvance;
  document.getElementById(`attendance-grid-${id}`).innerHTML = grid.join("");
  document.getElementById(`monthly-salary-${id}`).textContent =
    `₹${finalSalary.toFixed(2)} (Advance ₹${totalAdvance})`;

  const mobileGrid = document.getElementById(`attendance-grid-${id}-m`);
  if (mobileGrid) {
    mobileGrid.innerHTML = grid.join("");
    document.getElementById(`monthly-salary-${id}-m`).textContent =
      `₹${finalSalary.toFixed(2)} (Adv ₹${totalAdvance})`;
  }
};

window.toggleAttendance = function (id, monthKey, day) {
  if (!attendanceData[id][monthKey]) attendanceData[id][monthKey] = {};
  if (!advanceData[id][monthKey]) advanceData[id][monthKey] = {};
  let status = attendanceData[id][monthKey][day] || "";
  if (status === "") status = "P";
  else if (status === "P") status = "A";
  else if (status === "A") status = "H";
  else status = "";
  const currentAdv = advanceData[id][monthKey][day] || 0;
  const adv = prompt(
    `Enter advance amount for Day ${day} (current: ₹${currentAdv}):`,
    currentAdv
  );
  advanceData[id][monthKey][day] = parseFloat(adv) || 0;
  attendanceData[id][monthKey][day] = status;
  renderAttendanceGrid(id);
};

document.getElementById("employeeForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("name").value;
  const position = document.getElementById("position").value;
  const email = document.getElementById("email").value;
  const phone = document.getElementById("phone").value;
  const password = document.getElementById("password").value;
  const salary = parseFloat(document.getElementById("salary").value);
  await addDoc(collection(db, "employees"), {
    name, position, email, phone, password, salary,
    attendance: {}, advances: {}
  });
  document.getElementById("employeeForm").reset();
  loadEmployees();
});

window.updateEmployee = async function (id, mobile = false) {
  const empRef = doc(db, "employees", id);
  const prefix = mobile ? "-m" : "";
  const name = document.querySelector(`#name-${id}`)?.value || "";
  const position = document.getElementById(`position-${id}${prefix}`).value;
  const email = document.getElementById(`email-${id}${prefix}`).value;
  const phone = document.getElementById(`phone-${id}${prefix}`).value;
  const password = document.getElementById(`password-${id}${prefix}`).value;
  const salary = parseFloat(document.getElementById(`salary-${id}${prefix}`).value);
  await updateDoc(empRef, {
    name, position, email, phone, password, salary,
    attendance: attendanceData[id],
    advances: advanceData[id]
  });
  alert("Employee updated successfully!");
};

window.deleteEmployee = async function (id) {
  if (!confirm("Are you sure to delete this employee?")) return;
  await deleteDoc(doc(db, "employees", id));
  loadEmployees();
};

loadEmployees();
</script>
</body>
</html>
