<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Product Management</title>
<style>
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  background: #f8fafc;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 15px;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  max-width: 500px;
  margin-bottom: 20px;
}

header h1 {
  margin: 0;
  font-size: 24px;
  color: #2c3e50;
}

header button {
  padding: 8px 15px;
  border-radius: 8px;
  border: none;
  background: #2ecc71;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

header button:hover {
  background: #27ae60;
}

.card {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  padding: 20px;
  width: 100%;
  max-width: 500px;
  margin-bottom: 25px;
}

label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  color: #333;
}

input, select, button {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  box-sizing: border-box;
}

button {
  background: #3498db;
  color: white;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

button:hover {
  background: #2980b9;
}

.qty-row {
  display: flex;
  gap: 10px;
}

.qty-row select {
  flex: 1;
  min-width: 80px;
}

.qty-row input {
  flex: 3;
}

#suggestions {
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  position: absolute;
  z-index: 10;
  width: calc(100% - 22px);
  max-height: 150px;
  overflow-y: auto;
  display: none;
}

#suggestions div {
  padding: 8px;
  cursor: pointer;
}

#suggestions div:hover {
  background: #f0f0f0;
}

.table-container {
  width: 100%;
  max-width: 700px;
  overflow-x: auto;
  margin-top: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  text-align: center;
}

thead {
  background: #3498db;
  color: white;
}

th, td {
  padding: 12px;
  border: 1px solid #eee;
}

.delete-btn {
  background: #e74c3c;
  border: none;
  color: white;
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
}

.delete-btn:hover {
  background: #c0392b;
}

.month-filter {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  align-items: center;
  margin-top: 10px;
}

.filters select {
  margin: 5px;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.summary-box {
  background: #ecf0f1;
  border-radius: 12px;
  padding: 15px;
  margin-top: 15px;
  font-weight: bold;
  color: #2c3e50;
}

@media (max-width: 600px) {
  .table-container table, thead, tbody, th, td, tr {
    display: block;
  }
  thead { display: none; }
  tr {
    background: #fff;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 10px;
  }
  td {
    padding-left: 50%;
    text-align: left;
    position: relative;
  }
  td::before {
    position: absolute;
    left: 10px;
    font-weight: bold;
  }
  td:nth-of-type(1)::before { content: "Product"; }
  td:nth-of-type(2)::before { content: "Quantity"; }
  td:nth-of-type(3)::before { content: "Date"; }
  td:nth-of-type(4)::before { content: "Action"; }
}
</style>
</head>
<body>

<!-- Header with Employee button -->
<header>
  <h1>ðŸ“¦ Product Management</h1>
  <button id="employeeBtn" onclick="window.location.href='employee.html'">Employee</button>
</header>

<div class="card">
  <h2>Add Product</h2>
  <form id="productForm">
    <label>Product Name</label>
    <div style="position: relative;">
      <input type="text" id="productName" placeholder="Enter product name" autocomplete="off" required />
      <div id="suggestions"></div>
    </div>

    <label>Quantity</label>
    <div class="qty-row">
      <input type="number" id="productQty" placeholder="Enter quantity" required />
      <select id="qtyUnit">
        <option value="kg">kg</option>
        <option value="g">g</option>
      </select>
    </div>

    <button type="submit">âž• Add Product</button>
  </form>
</div>

<div class="card">
  <div class="month-filter">
    <h2>ðŸ—“ View Products by Month</h2>
    <div class="filters">
      <select id="monthSelect"></select>
      <select id="yearSelect"></select>
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Quantity</th>
          <th>Date & Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="productList"></tbody>
    </table>
  </div>

  <div id="summaryBox" class="summary-box" style="display:none;">
    <h3>ðŸ“Š Monthly Total Summary</h3>
    <div id="summaryContent"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDz-C00gltYO9zkYvcrGnaPVwCHcem-7jY",
  authDomain: "arafa-bakery-33906.firebaseapp.com",
  projectId: "arafa-bakery-33906",
  storageBucket: "arafa-bakery-33906.appspot.com",
  messagingSenderId: "362520951276",
  appId: "1:362520951276:web:ead930237865e9aa69e8c9",
  measurementId: "G-BY6R29F0QZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const productList = document.getElementById("productList");
const monthSelect = document.getElementById("monthSelect");
const yearSelect = document.getElementById("yearSelect");
const suggestionsBox = document.getElementById("suggestions");
const summaryBox = document.getElementById("summaryBox");
const summaryContent = document.getElementById("summaryContent");

const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const currentDate = new Date();
const currentMonth = currentDate.getMonth() + 1;
const currentYear = currentDate.getFullYear();

// Month/year dropdown
monthNames.forEach((m, i) => {
  const opt = document.createElement("option");
  opt.value = i + 1;
  opt.textContent = m;
  if (i + 1 === currentMonth) opt.selected = true;
  monthSelect.appendChild(opt);
});
for (let y = 2025; y <= 2035; y++) {
  const opt = document.createElement("option");
  opt.value = y;
  opt.textContent = y;
  if (y === currentYear) opt.selected = true;
  yearSelect.appendChild(opt);
}

let allData = [];
let allProducts = [];

async function loadProducts() {
  const q = query(collection(db, "products"), orderBy("datetime", "asc"));
  const snap = await getDocs(q);
  allData = [];
  const productSet = new Set(); // to keep only unique names

  snap.forEach(d => {
    const data = d.data();
    const time = data.datetime?.toDate ? data.datetime.toDate() : new Date();
    allData.push({ ...data, id: d.id, datetime: time });
    if (data.name) productSet.add(data.name.toLowerCase());
  });

  allProducts = Array.from(productSet); // only unique names
  displayProducts();
}

function displayProducts() {
  productList.innerHTML = "";
  summaryContent.innerHTML = "";
  summaryBox.style.display = "none";

  const selectedMonth = parseInt(monthSelect.value);
  const selectedYear = parseInt(yearSelect.value);

  const filtered = allData.filter(p => {
    const d = p.datetime;
    return d.getMonth() + 1 === selectedMonth && d.getFullYear() === selectedYear;
  });

  if (filtered.length === 0) {
    productList.innerHTML = `<tr><td colspan="4">No products found for this month.</td></tr>`;
    return;
  }

  filtered.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.qty} ${p.unit}</td>
      <td>${p.datetime.toLocaleString()}</td>
      <td><button class="delete-btn" data-id="${p.id}">Delete</button></td>
    `;
    productList.appendChild(tr);
  });

  // Monthly totals
  const totals = {};
  filtered.forEach(p => {
    const key = `${p.name.toLowerCase()}|${p.unit}`;
    totals[key] = (totals[key] || 0) + parseFloat(p.qty);
  });

  if (Object.keys(totals).length > 0) {
    summaryBox.style.display = "block";
    for (const [key, total] of Object.entries(totals)) {
      const [name, unit] = key.split("|");
      const div = document.createElement("div");
      div.textContent = `${name.charAt(0).toUpperCase() + name.slice(1)}: ${total} ${unit}`;
      summaryContent.appendChild(div);
    }
  }

  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.onclick = async () => {
      if (confirm("Delete this product?")) {
        await deleteDoc(doc(db, "products", btn.dataset.id));
        loadProducts();
      }
    };
  });
}

document.getElementById("productForm").onsubmit = async (e) => {
  e.preventDefault();
  const name = document.getElementById("productName").value.trim();
  const qty = parseFloat(document.getElementById("productQty").value);
  const unit = document.getElementById("qtyUnit").value;
  if (!name || qty <= 0) return alert("Enter valid details");

  await addDoc(collection(db, "products"), {
    name,
    qty,
    unit,
    datetime: serverTimestamp()
  });

  e.target.reset();
  suggestionsBox.style.display = "none";
  loadProducts();
};

// Unique Suggestions (No Duplicates)
const productInput = document.getElementById("productName");
productInput.addEventListener("input", () => {
  const val = productInput.value.toLowerCase();
  suggestionsBox.innerHTML = "";
  if (!val) return (suggestionsBox.style.display = "none");

  const matches = allProducts
    .filter(p => p.includes(val))
    .slice(0, 5); // limit 5 suggestions

  matches.forEach(m => {
    const div = document.createElement("div");
    div.textContent = m.charAt(0).toUpperCase() + m.slice(1);
    div.onclick = () => {
      productInput.value = div.textContent;
      suggestionsBox.style.display = "none";
    };
    suggestionsBox.appendChild(div);
  });

  suggestionsBox.style.display = matches.length ? "block" : "none";
});

monthSelect.onchange = displayProducts;
yearSelect.onchange = displayProducts;

window.onload = loadProducts;
</script>

</body>
</html>
