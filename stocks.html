<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üì¶ Stock Management</title>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f4f8fb;
  margin: 0;
  padding: 15px;
}
h1 {
  text-align: center;
  color: #3498db;
  font-size: 1.6rem;
  margin-bottom: 15px;
}

/* üîπ Form */
form {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  max-width: 450px;
  margin: auto;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  position: relative;
}
input, select, button {
  width: 100%;
  padding: 10px;
  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 10px;
  box-sizing: border-box;
}
button {
  background: #3498db;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  border: none;
}
button:hover {
  background: #2980b9;
}
.success {
  color: green;
  text-align: center;
  margin-top: 10px;
  font-weight: bold;
}
#notification {
  text-align: center;
  margin: 10px auto;
  color: #e74c3c;
  font-weight: bold;
}

/* üîç Suggestions box */
#suggestions {
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  max-height: 150px;
  overflow-y: auto;
  display: none;
  position: absolute;
  width: 88%;
  z-index: 50;
  margin-top: 5px;
}
#suggestions div {
  padding: 8px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}
#suggestions div:hover {
  background: #f1f1f1;
}

/* üîç Search box */
.search-box {
  text-align: center;
  margin: 20px auto;
}
.search-box input {
  width: 90%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #aaa;
}

/* üìã Table */
.table-container {
  margin-top: 25px;
  max-width: 650px;
  margin-left: auto;
  margin-right: auto;
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  font-size: 14px;
}
th, td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #ddd;
  white-space: nowrap;
}
th {
  background: #3498db;
  color: #fff;
}
.low-stock {
  background: #ffcccc;
  font-weight: bold;
  color: #a30000;
}
.action-btn {
  display: inline-block;
  padding: 6px 10px;
  border-radius: 6px;
  color: #fff;
  font-size: 13px;
  cursor: pointer;
  margin: 2px;
}
.sell {
  background: #e74c3c;
}
.progress-container {
  background: #eee;
  border-radius: 20px;
  height: 10px;
  width: 100%;
  overflow: hidden;
}
.progress-bar {
  height: 100%;
  transition: width 0.3s ease;
}
.level-text {
  font-size: 13px;
  font-weight: bold;
  color: #555;
  margin-top: 5px;
}

/* üì± Mobile Styles */
@media (max-width: 600px) {
  form { width: 95%; }
  #suggestions { width: 92%; }
}
</style>
</head>

<body>
<h1>üì¶ Stock Management</h1>

<form id="stockForm">

  <!-- üî• NEW SUGGESTION INPUT -->
  <input type="text" id="name" placeholder="Product Name" autocomplete="off" required>
  <div id="suggestions"></div>

  <select id="type" required>
    <option value="">Select Type</option>
    <option value="Stock Giving">Bought ‚ûï</option>
    <option value="Selling">Sell ‚ûñ</option>
  </select>

  <input type="number" step="0.01" id="quantity" placeholder="Quantity (Kg / Gram)" required>
  <input type="number" id="minLimit" step="0.01" placeholder="Minimum Limit (default 10)" min="0.01">

  <select id="alertType" required>
    <option value="Important">ALERT</option>
    <option value="Normal">NOT ALERT</option>
  </select>

  <button type="submit">Add / Update Stock</button>
</form>

<p id="msg" class="success"></p>
<p id="notification"></p>

<div class="search-box">
  <input type="text" id="search" placeholder="üîç Search Product...">
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Product</th>
        <th>Quantity (Kg)</th>
        <th>Min Limit</th>
        <th>Alert Type</th>
        <th>Level (%)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="stockTable"></tbody>
  </table>
</div>

<script type="module">

/* ---------- FIREBASE IMPORTS ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* ---------- FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDz-C00gltYO9zkYvcrGnaPVwCHcem-7jY",
  authDomain: "arafa-bakery-33906.firebaseapp.com",
  projectId: "arafa-bakery-33906",
  storageBucket: "arafa-bakery-33906.appspot.com",
  messagingSenderId: "362520951276",
  appId: "1:362520951276:web:ead930237865e9aa69e8c9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let stockData = [];

/* ---------- LOAD STOCK ---------- */
async function loadStock() {
  const querySnapshot = await getDocs(collection(db, "stocks"));
  stockData = [];
  querySnapshot.forEach(docSnap => {
    stockData.push({ id: docSnap.id, ...docSnap.data() });
  });
  stockData.sort((a, b) => a.name.localeCompare(b.name));
  renderTable();
}
loadStock();

/* ---------- LIVE SUGGESTIONS ---------- */
const nameInput = document.getElementById("name");
const suggestionsBox = document.getElementById("suggestions");

nameInput.addEventListener("input", () => {
  const text = nameInput.value.toLowerCase();
  suggestionsBox.innerHTML = "";

  if (text === "") {
    suggestionsBox.style.display = "none";
    return;
  }

  const matches = stockData.filter(s =>
    s.name.toLowerCase().includes(text)
  );

  if (matches.length === 0) {
    suggestionsBox.style.display = "none";
    return;
  }

  matches.forEach(item => {
    const div = document.createElement("div");
    div.textContent = item.name;
    div.onclick = () => {
      nameInput.value = item.name;
      suggestionsBox.style.display = "none";
    };
    suggestionsBox.appendChild(div);
  });

  suggestionsBox.style.display = "block";
});

document.addEventListener("click", (e) => {
  if (e.target !== nameInput) suggestionsBox.style.display = "none";
});

/* ---------- RENDER TABLE ---------- */
function renderTable(searchText = "") {
  const table = document.getElementById("stockTable");
  table.innerHTML = "";

  let filtered = stockData.filter(s =>
    s.name.toLowerCase().includes(searchText.toLowerCase())
  );

  filtered.forEach((stock, index) => {
    const low = stock.quantity <= stock.minLimit;
    const percent = Math.min((stock.quantity / stock.minLimit) * 100, 100);

    const tr = document.createElement("tr");
    tr.className = low ? "low-stock" : "";

    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${stock.name}</td>
      <td>${stock.quantity.toFixed(2)}</td>
      <td>${stock.minLimit.toFixed(2)}</td>
      <td>${stock.alertType}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${percent}%; background:${low ? '#e74c3c' : '#27ae60'}"></div>
        </div>
        <div class="level-text">${percent.toFixed(0)}%</div>
      </td>
    `;
    table.appendChild(tr);
  });
}

/* ---------- SEARCH FILTER ---------- */
document.getElementById("search").addEventListener("input", (e) => {
  renderTable(e.target.value);
});

/* ---------- ADD / UPDATE ---------- */
document.getElementById('stockForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const name = nameInput.value.trim();
  const qty = parseFloat(document.getElementById('quantity').value);
  const type = document.getElementById('type').value;
  let minLimit = parseFloat(document.getElementById('minLimit').value);
  if (!minLimit) minLimit = 10;

  const alertType = document.getElementById('alertType').value;

  const existing = stockData.find(s => s.name.toLowerCase() === name.toLowerCase());
  let newQty = qty;

  if (existing) {
    if (type === "Stock Giving") newQty = existing.quantity + qty;
    if (type === "Selling") newQty = Math.max(existing.quantity - qty, 0);

    await updateDoc(doc(db, "stocks", existing.id), {
      quantity: parseFloat(newQty.toFixed(2)),
      minLimit,
      alertType,
      lastUpdated: new Date().toISOString(),
    });
  } else {
    await addDoc(collection(db, "stocks"), {
      name,
      quantity: type === "Selling" ? 0 : qty,
      minLimit,
      alertType,
      lastUpdated: new Date().toISOString()
    });
  }

  document.getElementById("msg").textContent = "‚úÖ Stock Updated!";
  e.target.reset();
  loadStock();
});

</script>
</body>
</html>
