<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üì¶ Stock Management</title>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f4f8fb;
  margin: 0;
  padding: 15px;
}
h1 {
  text-align: center;
  color: #3498db;
  font-size: 1.6rem;
  margin-bottom: 15px;
}

/* üîπ Form */
form {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  max-width: 450px;
  margin: auto;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
input, select, button {
  width: 100%;
  padding: 10px;
  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 10px;
  box-sizing: border-box;
}
button {
  background: #3498db;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  border: none;
}
button:hover {
  background: #2980b9;
}
.success {
  color: green;
  text-align: center;
  margin-top: 10px;
  font-weight: bold;
}
#notification {
  text-align: center;
  margin: 10px auto;
  color: #e74c3c;
  font-weight: bold;
}

/* üîç Search box */
.search-box {
  text-align: center;
  margin: 20px auto;
}
.search-box input {
  width: 90%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #aaa;
}

/* üìã Table */
.table-container {
  margin-top: 25px;
  max-width: 650px;
  margin-left: auto;
  margin-right: auto;
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  font-size: 14px;
}
th, td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #ddd;
  white-space: nowrap;
}
th {
  background: #3498db;
  color: #fff;
}
.low-stock {
  background: #ffcccc;
  font-weight: bold;
  color: #a30000;
}
.action-btn {
  display: inline-block;
  padding: 6px 10px;
  border-radius: 6px;
  color: #fff;
  font-size: 13px;
  cursor: pointer;
  margin: 2px;
}
.sell {
  background: #e74c3c;
}
.progress-container {
  background: #eee;
  border-radius: 20px;
  height: 10px;
  width: 100%;
  overflow: hidden;
}
.progress-bar {
  height: 100%;
  transition: width 0.3s ease;
}
.level-text {
  font-size: 13px;
  font-weight: bold;
  color: #555;
  margin-top: 5px;
}

/* üì± Mobile Styles */
@media (max-width: 600px) {
  body {
    padding: 10px;
  }
  h1 {
    font-size: 1.3rem;
  }
  form {
    padding: 15px;
    width: 95%;
  }
  input, select, button {
    font-size: 14px;
    padding: 9px;
  }
  .table-container {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  table {
    font-size: 12px;
    min-width: 600px; /* Allows horizontal scroll on phone */
  }
  th, td {
    padding: 8px;
  }
  .search-box input {
    width: 95%;
  }
  .action-btn {
    font-size: 12px;
    padding: 5px 8px;
  }
}
</style>
</head>

<body>
<h1>üì¶ Stock Management</h1>

<form id="stockForm">
  <input list="productList" type="text" id="name" placeholder="Product Name" required>
  <datalist id="productList"></datalist>
  <select id="type" required>
    <option value="">Select Type</option>
    <option value="Stock Giving">Bought ‚ûï</option>
    <option value="Selling">Sell ‚ûñ</option>
  </select>
  <input type="number" step="0.01" id="quantity" placeholder="Quantity (Kg / Gram)" required>
  <input type="number" id="minLimit" step="0.01" placeholder="Minimum Limit (default 10)" min="0.01">
  <select id="alertType" required>
    <option value="Important">ALERT</option>
    <option value="Normal">NOT ALERT</option>
  </select>
  <button type="submit">Add / Update Stock</button>
</form>

<p id="msg" class="success"></p>
<p id="notification"></p>

<div class="search-box">
  <input type="text" id="search" placeholder="üîç Search Product...">
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Product</th>
        <th>Quantity (Kg)</th>
        <th>Min Limit</th>
        <th>Alert Type</th>
        <th>Level (%)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="stockTable"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// üî• Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDz-C00gltYO9zkYvcrGnaPVwCHcem-7jY",
  authDomain: "arafa-bakery-33906.firebaseapp.com",
  projectId: "arafa-bakery-33906",
  storageBucket: "arafa-bakery-33906.appspot.com",
  messagingSenderId: "362520951276",
  appId: "1:362520951276:web:ead930237865e9aa69e8c9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let stockData = [];

// üü¢ Load Stocks
async function loadStock() {
  const querySnapshot = await getDocs(collection(db, "stocks"));
  stockData = [];
  querySnapshot.forEach(docSnap => {
    stockData.push({ id: docSnap.id, ...docSnap.data() });
  });
  stockData.sort((a, b) => a.name.localeCompare(b.name));
  updateProductList();
  renderTable();
}

// üßæ Render Stock Table
function renderTable(searchText = "") {
  const table = document.getElementById("stockTable");
  const notification = document.getElementById("notification");
  table.innerHTML = "";
  notification.textContent = "";

  let filtered = stockData.filter(s =>
    s.name.toLowerCase().includes(searchText.toLowerCase())
  );

  filtered.sort((a, b) => {
    const aLow = a.quantity <= a.minLimit ? 1 : 0;
    const bLow = b.quantity <= b.minLimit ? 1 : 0;
    return bLow - aLow || a.name.localeCompare(b.name);
  });

  const importantLowStock = filtered.filter(
    s => s.quantity <= s.minLimit && s.alertType === "Important"
  );

  if (importantLowStock.length > 0) {
    notification.textContent =
      "‚ö†Ô∏è Important Low Stock: " +
      importantLowStock.map(i => i.name).join(", ");
  }

  filtered.forEach((stock, index) => {
    const low = stock.quantity <= stock.minLimit;
    const percent = Math.min((stock.quantity / stock.minLimit) * 100, 100);

    const tr = document.createElement("tr");
    tr.className = low ? "low-stock" : "";

    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${stock.name}</td>
      <td>${stock.quantity.toFixed(2)}</td>
      <td>${stock.minLimit.toFixed(2)}</td>
      <td>${stock.alertType}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${percent}%; background:${low ? '#e74c3c' : '#27ae60'}"></div>
        </div>
        <div class="level-text">${percent.toFixed(0)}%</div>
      </td>
      <td>
        <span class="action-btn sell" style="background:#555;" onclick="deleteItem('${stock.id}')">Delete</span>
      </td>
    `;
    table.appendChild(tr);
  });
}

// üßæ Update datalist
function updateProductList() {
  const list = document.getElementById("productList");
  list.innerHTML = "";
  const sorted = [...stockData].sort((a, b) => a.name.localeCompare(b.name));
  sorted.forEach(s => {
    const option = document.createElement("option");
    option.value = s.name;
    list.appendChild(option);
  });
}

// üîç Search
document.getElementById("search").addEventListener("input", (e) => {
  renderTable(e.target.value);
});

// ‚ùå Delete
window.deleteItem = async (id) => {
  if (confirm("Delete this item?")) {
    await deleteDoc(doc(db, "stocks", id));
    await loadStock();
  }
};

// üü¢ Add / Update
document.getElementById('stockForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const productName = document.getElementById('name').value.trim();
  let minLimitInput = parseFloat(document.getElementById('minLimit').value);
  const quantityInput = parseFloat(document.getElementById('quantity').value);
  const type = document.getElementById('type').value;
  const alertType = document.getElementById('alertType').value;
  if (!minLimitInput) minLimitInput = 10.0;

  const existing = stockData.find(s => s.name.toLowerCase() === productName.toLowerCase());
  let newQty = quantityInput;

  if (existing) {
    if (type === "Stock Giving") {
      newQty = existing.quantity + quantityInput;
    } else if (type === "Selling") {
      newQty = Math.max(existing.quantity - quantityInput, 0);
    }
    await updateDoc(doc(db, "stocks", existing.id), {
      quantity: parseFloat(newQty.toFixed(2)),
      minLimit: parseFloat(minLimitInput.toFixed(2)),
      alertType,
      lastUpdated: new Date().toISOString()
    });
  } else {
    const data = {
      name: productName,
      type,
      quantity: type === "Selling" ? 0 : parseFloat(quantityInput.toFixed(2)),
      minLimit: parseFloat(minLimitInput.toFixed(2)),
      alertType,
      lastUpdated: new Date().toISOString()
    };
    await addDoc(collection(db, "stocks"), data);
  }

  document.getElementById("msg").textContent = "‚úÖ Stock updated successfully!";
  e.target.reset();
  await loadStock();
});

// Initial load
loadStock();
</script>
</body>
</html>
